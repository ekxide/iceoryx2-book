<svg viewBox="0 0 800 500" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <marker id="arrowhead" markerWidth="8" markerHeight="6" 
     refX="7" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#6c7b7f" />
    </marker>
    <marker id="eventarrow" markerWidth="8" markerHeight="6" 
     refX="7" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#9ca3af" />
    </marker>
    <marker id="greenarrow" markerWidth="8" markerHeight="6" 
     refX="7" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#6b7280" />
    </marker>
    <pattern id="waitPattern" patternUnits="userSpaceOnUse" width="4" height="4">
      <circle cx="2" cy="2" r="1" fill="#9ca3af" opacity="0.3"/>
    </pattern>
  </defs>
  
  <!-- Background -->
  <rect width="800" height="500" fill="transparent"/>
  
  <!-- Event Sources Column -->
  
  <!-- Timer -->
  <rect x="70" y="100" width="100" height="50" fill="#e5e7eb" stroke="#6c7b7f" stroke-width="2" />
  <text x="120" y="115" text-anchor="middle" font-size="10" font-weight="bold" fill="#374151">Interval Timer</text>
  <text x="120" y="128" text-anchor="middle" font-size="8" fill="#374151">10ms interval</text>
  <text x="120" y="142" text-anchor="middle" font-size="7" fill="#6b7280">TICK!</text>
  
  <!-- Listener Port -->
  <rect x="70" y="180" width="100" height="50" fill="#e5e7eb" stroke="#6c7b7f" stroke-width="2" />
  <text x="120" y="195" text-anchor="middle" font-size="10" font-weight="bold" fill="#374151">Listener Port</text>
  <text x="120" y="208" text-anchor="middle" font-size="8" fill="#374151">Service: /sensors</text>
  <rect x="95" y="215" width="50" height="8" fill="#6b7280"/>
  <text x="120" y="221" text-anchor="middle" font-size="7" fill="white">NEW DATA</text>
  
  <!-- File Descriptor -->
  <rect x="70" y="260" width="100" height="50" fill="#f3f4f6" stroke="#9ca3af" stroke-width="2"/>
  <text x="120" y="275" text-anchor="middle" font-size="10" fill="#9ca3af">File Descriptor</text>
  <text x="120" y="288" text-anchor="middle" font-size="8" fill="#9ca3af">Socket fd: 7</text>
  <text x="120" y="300" text-anchor="middle" font-size="7" fill="#9ca3af">waiting...</text>
  
  <!-- Deadline Timer -->
  <rect x="70" y="340" width="100" height="50" fill="#f3f4f6" stroke="#9ca3af" stroke-width="2"/>
  <text x="120" y="355" text-anchor="middle" font-size="10" fill="#9ca3af">Deadline Timer</text>
  <text x="120" y="368" text-anchor="middle" font-size="8" fill="#9ca3af">Timeout: 500ms</text>
  <text x="120" y="380" text-anchor="middle" font-size="7" fill="#9ca3af">not elapsed</text>
  
  <!-- Waitset Core -->
  <rect x="280" y="150" width="240" height="220" fill="#4b5563" stroke="#374151" stroke-width="2" />
  <text x="400" y="175" text-anchor="middle" font-size="14" font-weight="bold" fill="white">Waitset</text>
  
  <!-- Event queue inside Waitset -->
  <rect x="295" y="190" width="210" height="70" fill="rgba(255,255,255,0.2)" stroke="white" stroke-width="1"/>
  <text x="400" y="205" text-anchor="middle" font-size="9" fill="white">Event Queue</text>
  
  <!-- Queued events -->
  <rect x="305" y="215" width="50" height="15" fill="#6b7280" stroke="#6c7b7f" stroke-width="1"/>
  <text x="330" y="225" text-anchor="middle" font-size="7" fill="white">Timer Event</text>
  
  <rect x="365" y="215" width="50" height="15" fill="#6b7280" stroke="#6c7b7f" stroke-width="1"/>
  <text x="390" y="225" text-anchor="middle" font-size="7" fill="white">Data Event</text>
  
  <rect x="425" y="215" width="70" height="15" fill="url(#waitPattern)" stroke="#9ca3af" stroke-width="1" stroke-dasharray="2,2"/>
  <text x="460" y="225" text-anchor="middle" font-size="7" fill="white">empty slots...</text>
  
  <rect x="305" y="238" width="190" height="15" fill="url(#waitPattern)" stroke="#9ca3af" stroke-width="1" stroke-dasharray="2,2"/>
  <text x="400" y="248" text-anchor="middle" font-size="7" fill="white">...</text>
  
  <!-- Multiplexing mechanisms inside Waitset -->
  
  <!-- Row 1 of multiplexers -->
  <rect x="295" y="275" width="50" height="25" fill="#9ca3af" stroke="#6c7b7f"/>
  <text x="320" y="289" text-anchor="middle" font-size="8" fill="white">select</text>
  
  <rect x="355" y="275" width="50" height="25" fill="#9ca3af" stroke="#6c7b7f"/>
  <text x="380" y="289" text-anchor="middle" font-size="8" fill="white">epoll</text>
  
  <rect x="415" y="275" width="40" height="25" fill="#9ca3af" stroke="#6c7b7f"/>
  <text x="435" y="289" text-anchor="middle" font-size="8" fill="white">poll</text>
  
  <rect x="465" y="275" width="35" height="25" fill="#9ca3af" stroke="#6c7b7f"/>
  <text x="482" y="289" text-anchor="middle" font-size="8" fill="white">...</text>
  
  <!-- Row 2 of multiplexers -->
  <rect x="295" y="310" width="60" height="25" fill="#9ca3af" stroke="#6c7b7f"/>
  <text x="325" y="324" text-anchor="middle" font-size="8" fill="white">WSAPoll</text>
  
  <rect x="365" y="310" width="60" height="25" fill="#9ca3af" stroke="#6c7b7f"/>
  <text x="395" y="324" text-anchor="middle" font-size="8" fill="white">inotify</text>
  
  <rect x="435" y="310" width="60" height="25" fill="#9ca3af" stroke="#6c7b7f"/>
  <text x="465" y="324" text-anchor="middle" font-size="8" fill="white">knotify</text>
  
  <!-- Thread Pipeline -->
  
  <!-- Sleep State -->
  <circle cx="650" cy="225" r="22" fill="url(#waitPattern)" stroke="#9ca3af" stroke-width="2" stroke-dasharray="5,5"/>
  <text x="650" y="230" text-anchor="middle" font-size="9" font-weight="bold" fill="#9ca3af">SLEEP</text>
  
  <!-- Wake-up arrow -->
  <line x1="650" y1="247" x2="650" y2="273" stroke="#6c7b7f" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- Process State -->
  <circle cx="650" cy="300" r="28" fill="#374151" stroke="#6c7b7f" stroke-width="2"/>
  <text x="650" y="303" text-anchor="middle" font-size="9" font-weight="bold" fill="white">PROCESS</text>
  <text x="650" y="312" text-anchor="middle" font-size="7" fill="white">Handle Events</text>
  
  <!-- Rounded loop back arrow -->
  <path d="M 678 300 Q 720 300 720 262 Q 720 225 678 225" fill="none" stroke="#6c7b7f" stroke-width="2" marker-end="url(#arrowhead)" stroke-dasharray="3,3"/>
  <text x="780" y="225" text-anchor="middle" font-size="8" fill="#6c7b7f" transform="rotate(90 740 217)">loop</text>
  
  <!-- Event flow arrows -->
  <line x1="170" y1="125" x2="278" y2="200" stroke="#9ca3af" stroke-width="2" marker-end="url(#eventarrow)"/>
  <text x="215" y="150" font-size="8" fill="#6b7280">event</text>
  
  <line x1="170" y1="205" x2="278" y2="225" stroke="#9ca3af" stroke-width="2" marker-end="url(#eventarrow)"/>
  <text x="215" y="210" font-size="8" fill="#6b7280">event</text>
  
  <!-- Wake signal from waitset to pipeline -->
  <line x1="521" y1="225" x2="625" y2="225" stroke="#6b7280" stroke-width="2" marker-end="url(#greenarrow)"/>
  <text x="575" y="210" text-anchor="middle" font-size="9" fill="#6b7280">wake up</text>
  
</svg>
